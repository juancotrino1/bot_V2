name: Trading System V3 - Production Ready

on:
  schedule:
    # Ejecutar cada hora (puedes ajustar seg√∫n necesites)
    - cron: "0 * * * *"
  
  # Permite ejecuci√≥n manual desde GitHub
  workflow_dispatch:
    inputs:
      debug:
        description: 'Activar modo debug'
        required: false
        default: 'false'
        type: boolean
      tickers:
        description: 'Tickers espec√≠ficos (separados por coma, ej: BTC-USD,ETH-USD)'
        required: false
        default: ''
        type: string
      conservative:
        description: 'Usar configuraci√≥n conservadora'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-trading-system:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # L√≠mite de seguridad aumentado para primera ejecuci√≥n
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'  # Cach√© autom√°tico de dependencias pip
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Cach√© de datos de trading (persiste entre ejecuciones del mismo d√≠a)
      - name: Cache trading data
        uses: actions/cache@v4
        with:
          path: cache_datos/
          key: ${{ runner.os }}-trading-data-${{ hashFiles('**/trading_system_v3_optimized.py') }}-${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}-trading-data-${{ hashFiles('**/trading_system_v3_optimized.py') }}-
            ${{ runner.os }}-trading-data-
      
      # Cach√© de modelos ML entrenados (persiste mientras no cambie el c√≥digo)
      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: modelos_trading/
          key: ${{ runner.os }}-ml-models-${{ hashFiles('**/trading_system_v3_optimized.py') }}
          restore-keys: |
            ${{ runner.os }}-ml-models-
      
      - name: Verify Python environment
        run: |
          python --version
          pip list | grep -E '(yfinance|pandas|sklearn|numpy)'
      
      - name: Run trading system
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONUNBUFFERED: 1  # Para ver logs en tiempo real
        run: |
          # Construir argumentos seg√∫n inputs
          ARGS=""
          
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            echo "üêõ Modo DEBUG activado"
            ARGS="$ARGS --debug"
          fi
          
          if [ -n "${{ github.event.inputs.tickers }}" ]; then
            echo "üéØ Tickers espec√≠ficos: ${{ github.event.inputs.tickers }}"
            ARGS="$ARGS --tickers ${{ github.event.inputs.tickers }}"
          fi
          
          if [ "${{ github.event.inputs.conservative }}" = "true" ]; then
            echo "üõ°Ô∏è Modo conservador activado"
            # Nota: Esto requiere que el script soporte --conservative
            # Alternativa: usar ejemplo_uso_v3.py --conservative
          fi
          
          # Ejecutar sistema
          echo "üöÄ Iniciando sistema de trading..."
          python trading_system_v3_optimized.py $ARGS
      
      # Guardar logs siempre (no solo en fallo)
      - name: Upload execution logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_number }}
          path: |
            *.log
            ultima_senal.json
            cache_datos/*.pkl
          retention-days: 7
          if-no-files-found: ignore
      
      # Backup de modelos entrenados
      - name: Upload trained models
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ml-models-${{ github.run_number }}
          path: modelos_trading/
          retention-days: 30
          if-no-files-found: ignore
      
      # Notificaci√≥n de √©xito (opcional)
      - name: Notify success
        if: success() && vars.NOTIFY_SUCCESS == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="‚úÖ Trading System ejecutado exitosamente
            
            üïí Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            üî¢ Run: ${{ github.run_number }}
            üìä Workflow: ${{ github.workflow }}"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE" \
              -d parse_mode="HTML" || echo "‚ö†Ô∏è No se pudo enviar notificaci√≥n de √©xito"
          fi
      
      # Notificaci√≥n de fallo
      - name: Notify failure
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="‚ö†Ô∏è Trading System fall√≥ en GitHub Actions
            
            üïí Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            üî¢ Run: ${{ github.run_number }}
            üîó Ver logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ‚ö†Ô∏è Revisar logs para m√°s detalles."
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE" \
              -d parse_mode="HTML" || echo "‚ö†Ô∏è No se pudo enviar notificaci√≥n de error"
          else
            echo "‚ö†Ô∏è Telegram no configurado. Configura TELEGRAM_TOKEN y TELEGRAM_CHAT_ID en los secrets."
          fi
      
      # Cleanup en caso de error
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "üßπ Limpiando archivos temporales..."
          rm -f *.pkl *.log 2>/dev/null || true
          echo "‚úÖ Cleanup completado"

# Configuraci√≥n de concurrencia (evita ejecuciones simult√°neas)
concurrency:
  group: trading-system-v3
  cancel-in-progress: false  # No cancelar ejecuciones en progreso
